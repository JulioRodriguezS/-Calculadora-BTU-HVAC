<!-- /app/index.html -->
<!DOCTYPE html>
<html lang="es" class="ion-dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculadora BTU</title>

    <!-- Ionic Core (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <!-- jsPDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <style>
      :root{
        --app-bg:#0b0f13; --card-bg:#12171d; --muted:#9aa4b2; --accent:#313132; --danger:#f87171; --ok:#fbfcff;
        --ion-background-color:var(--app-bg); --ion-text-color:#e5e7eb; --ion-card-background:var(--card-bg);
        --ion-color-primary:var(--accent); --ion-color-primary-contrast:#0b0f13;
      }
      ion-content{ --padding-start:14px; --padding-end:14px; --padding-bottom:24px; }
      ion-card{ border-radius:18px; }
      .row{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px; }
      @media(min-width:880px){ .row-3{ grid-template-columns:repeat(3,1fr); } }
      .hint{ color:var(--muted); font-size:.82rem; }
      .mono{ font-variant-numeric:tabular-nums; font-family:ui-monospace, Menlo, Consolas, monospace; }
      .kpi{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; }
      .box{ background:#0f141a; border-radius:16px; padding:16px; box-shadow:0 0 0 1px #1f2937 inset; }
      .box h1{ margin:0 0 8px; font-size:1.1rem; color:var(--muted); font-weight:600; }
      .box .val{ font-size:1.6rem; font-weight:800; }
      .chips{ display:flex; flex-wrap:wrap; gap:8px; }
      .chip{ background:#0e141a; border:1px solid #1f2937; border-radius:999px; padding:6px 10px; font-size:.85rem; }
      .ok{ color:var(--ok); } .warn{ color:var(--danger); }
      ion-item{ margin-top:1px; border:1px solid #1f2937; }
      ion-input,ion-textarea{ --background:#ffffff; --padding-top:10px; --padding-bottom:10px; border-radius:12px; }
      ion-card-title{ color:cornflowerblue; }
      .cta{ margin-top:8px; display:flex; gap:8px; color:#ffffff; }
      .right{ text-align:right; }
      .muted{ color:var(--muted); }
      .logo{ width:22px; height:22px; vertical-align:-5px; margin-right:8px; border-radius:4px; }
    </style>
  </head>

  <body>
    <ion-app>
      <ion-header translucent="true">
        <ion-toolbar color="dark">
          <ion-title>
            <ion-icon name="snow-outline" style="vertical-align:-3px;margin-right:6px;"></ion-icon>
            Calculadora BTU • HVAC
          </ion-title>
          <ion-buttons slot="end">
            <ion-button id="btnReset" fill="clear" aria-label="Reiniciar">
              <ion-icon name="refresh-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content fullscreen="true">
        <!-- DATOS DEL CLIENTE -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Datos del cliente (opcional)</ion-card-title>
            <ion-card-subtitle class="muted">Se muestran en el PDF si están llenos.</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <div class="row">
              <ion-item fill="solid">
                <ion-label position="stacked">Nombre</ion-label>
                <ion-input id="clienteNombre" type="text" placeholder="Juan Perez"></ion-input>
              </ion-item>
              <ion-item fill="solid">
                <ion-label position="stacked">Teléfono</ion-label>
                <ion-input id="clienteTelefono" type="tel" placeholder="9981554466" inputmode="tel"></ion-input>
              </ion-item>
            </div>
            <ion-item fill="solid">
              <ion-label position="stacked">Dirección</ion-label>
              <ion-textarea id="clienteDireccion" placeholder="San Francisco 730, Colonia Fuentes de San Hildefonso" auto-grow="true"></ion-textarea>
            </ion-item>
          </ion-card-content>
        </ion-card>

        <!-- ENTRADAS -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Entradas</ion-card-title>
            <ion-card-subtitle class="muted">Todo suma al TOTAL.</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <div class="row">
              <ion-item fill="solid">
                <ion-label position="stacked">Área del local (m²)</ion-label>
                <ion-input id="area" type="number" step="0.01" inputmode="decimal" placeholder="75"></ion-input>
              </ion-item>
              <ion-item fill="solid">
                <ion-label position="stacked">Personas</ion-label>
                <ion-input id="personas" type="number" step="1" inputmode="numeric" placeholder="23"></ion-input>
              </ion-item>
            </div>
            <div class="row">
              <ion-item fill="solid">
                <ion-label position="stacked">Área total de ventanas (m²)</ion-label>
                <ion-input id="areaVentanas" type="number" step="0.01" inputmode="decimal" placeholder="9.6"></ion-input>
              </ion-item>
              <ion-item fill="solid">
                <ion-label position="stacked">Luminarias (unidades)</ion-label>
                <ion-input id="luminarias" type="number" step="1" inputmode="numeric" placeholder="20"></ion-input>
              </ion-item>
            </div>

            <ion-item lines="full" style="margin-top:6px;">
              <ion-label>Permitir sobrecapacidad</ion-label>
              <ion-toggle id="toggleOvershoot" checked="true"></ion-toggle>
            </ion-item>

            <div class="cta">
              <ion-button id="btnCalcular" expand="block" style="color:#e5e7eb;border-radius:2px;border:2px solid #e5e7eb;">
                <ion-icon slot="start" name="calculator-outline"></ion-icon> Calcular
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- RESULTADO -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Resultado</ion-card-title>
            <ion-card-subtitle class="muted">Total requerido</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <div class="kpi">
              <div class="box">
                <h1>Total BTU</h1>
                <div class="val mono" id="s5">—</div>
                <div class="hint">Toneladas ≈ <span class="mono" id="tons">—</span></div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- COMBINACIONES + EXPORT -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Sección 6 · Combinación de equipos</ion-card-title>
            <ion-card-subtitle class="muted">Sugerencias top (cercanas al total)</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content class="grid">
            <div id="combos"></div>
            <div id="nota" class="hint" style="margin-top:8px;"></div>
            <div class="cta" style="margin-top:10px;">
              <ion-button id="btnPdf" fill="outline" color="medium" expand="block" style="color:#fbfcff !important;">
                <ion-icon slot="start" name="download-outline"></ion-icon> Descargar PDF
              </ion-button>
              <ion-button id="btnShare" expand="block" color="primary" style="display: none;">
                <ion-icon slot="start" name="share-social-outline"></ion-icon> Compartir
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>

        <ion-footer collapse="fade">
          <ion-toolbar>
            <ion-title size="small" class="muted">Ionic Dark UI</ion-title>
          </ion-toolbar>
        </ion-footer>
      </ion-content>
    </ion-app>

    <script type="module">
      // Constantes
      const BASE_AREA_M2=30, BASE_AREA_BTUS=28800;
      const BTU_POR_PERSONA=650, BTU_POR_M2_VENTANA=450, BTU_POR_LUMINARIA=200;
      const CAPACIDADES_KBTU=[12,18,24,36,46];
      const MIN_CAP_KBTU=Math.min(...CAPACIDADES_KBTU);

      const fmt=new Intl.NumberFormat('es-MX');
      const $=(id)=>document.getElementById(id);
      const n=(v)=>{const x=parseFloat(String(v).replace(',','.')); return Number.isFinite(x)?x:0;};
      const tonsFromBTU=(btus)=>btus/12000;

      let lastTotal=0, lastCombos=[];

      async function loadLogoDataURL(){
        try{
          const url=new URL('logo.png', document.baseURI).toString();
          const resp=await fetch(url); if(!resp.ok) return null;
          const blob=await resp.blob();
          return await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(blob);});
        }catch{ return null; }
      }

      function mejoresCombos(target, unidadesBTU, maxEquipos=4, permitirSobre=true, topN=5){
        const res=[]; let bestAbs=Infinity;
        unidadesBTU.sort((a,b)=>b-a);
        const rank=(a,b)=> a.diff-b.diff || a.equipos-b.equipos || (permitirSobre?((a.suma>=target?0:1)-(b.suma>=target?0:1)):0) || (b.suma-a.suma);
        function push(combo){
          const suma=combo.reduce((a,b)=>a+b,0), diff=Math.abs(target-suma);
          const item={listaBTU:[...combo], suma, diff, equipos:combo.length};
          if(!res.some(x=>x.suma===suma && x.equipos===item.equipos)){ res.push(item); res.sort(rank); if(res.length>topN) res.length=topN; bestAbs=res[0]?.diff??bestAbs; }
        }
        function dfs(i, combo, suma){
          if(combo.length>0) push(combo);
          if(combo.length===maxEquipos) return;
          for(let idx=i; idx<unidadesBTU.length; idx++){
            const cap=unidadesBTU[idx], ns=suma+cap;
            if(!permitirSobre && ns>target) continue;
            if(res.length && Math.abs(target-ns)>bestAbs+cap) continue;
            combo.push(cap); dfs(idx, combo, ns); combo.pop();
          }
        }
        dfs(0,[],0); return res;
      }

      function calcular(){
        const area=Math.max(0,n($("area").value));
        const personas=Math.max(0,Math.floor(n($("personas").value)));
        const areaVentanas=Math.max(0,n($("areaVentanas").value));
        const luminarias=Math.max(0,Math.floor(n($("luminarias").value)));

        const btusArea=(BASE_AREA_BTUS*area)/BASE_AREA_M2;
        const btusPersonas=BTU_POR_PERSONA*personas;
        const btusVentanas=BTU_POR_M2_VENTANA*areaVentanas;
        const btusLuminarias=BTU_POR_LUMINARIA*luminarias;
        const total=btusArea+btusPersonas+btusVentanas+btusLuminarias;

        $("s5").textContent=fmt.format(Math.round(total))+" BTU";
        $("tons").textContent=tonsFromBTU(total).toFixed(2)+" ton";

        lastTotal=total; pintarCombos(total);
      }

      function pintarCombos(totalBTU){
        const unidades=CAPACIDADES_KBTU.map(k=>Math.round(k*1000));
        const overshoot=$("toggleOvershoot").checked;
        const autoMax=Math.min(8, Math.max(3, Math.ceil(totalBTU/(MIN_CAP_KBTU*1000))+2));
        const combos=mejoresCombos(totalBTU, unidades, autoMax, overshoot, 5);
        lastCombos=combos;

        const cont=$("combos"); cont.innerHTML="";
        if(!combos.length){
          cont.innerHTML=`<div class="hint">No hay combinación posible con los límites actuales.</div>`;
          $("nota").textContent=""; return;
        }

        cont.innerHTML=combos.map((c,i)=>{
          const diff=c.suma-lastTotal, sign=diff>=0?"+":"−", abs=Math.abs(diff), clase=diff>=0?"ok":"warn";
          const k=c.listaBTU.map(x=>Math.round(x/1000));
          return `
            <ion-item lines="full">
              <ion-label>
                <div><strong>#${i+1}</strong> • ${c.equipos} equipo(s)</div>
                <div class="chips" style="margin:6px 0 8px;">${k.map(x=>`<span class="chip">${x} KBTU</span>`).join("")}</div>
                <div class="muted">Suma: <span class="mono">${fmt.format(Math.round(c.suma))}</span> BTU · ≈ <span class="mono">${tonsFromBTU(c.suma).toFixed(2)}</span> ton</div>
              </ion-label>
              <div slot="end" class="right">
                <div class="mono ${clase}">${sign}${fmt.format(Math.round(abs))} BTU</div>
                <div class="hint">vs. objetivo</div>
              </div>
            </ion-item>`;
        }).join("");

        const minCap=Math.min(...unidades);
        $("nota").innerHTML = `
          Objetivo: <span class="mono">${fmt.format(Math.round(totalBTU))} BTU</span>.
          ${overshoot ? "Se permiten combinaciones que excedan el objetivo." : "No se permite exceder; intenta con más equipos."}
          Capacidad mínima: <span class="mono">${Math.round(minCap/1000)} KBTU</span>.
          Máx. equipos (auto): <span class="mono">${autoMax}</span>.`;
      }

      // --- Construcción de PDF reutilizable (descargar/compartir) ---
      async function buildPdf(){
        const { jsPDF } = window.jspdf;
        const doc=new jsPDF({ unit:'mm', format:'a4' });
        const logo=await loadLogoDataURL();
        const now=new Date(); const fecha=now.toLocaleString('es-MX');
        const fileName=`JC-HVAC-BTU-${now.toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`;

        // Encabezado
        doc.setFont('helvetica','bold'); doc.setFontSize(16);
        doc.text('Put Your Logo Here',14,18);
        if(logo){ try{ doc.addImage(logo,'PNG',170,10,26,26); }catch{} }
        doc.setFont('helvetica','normal'); doc.setFontSize(11);
        doc.text('Reporte de cálculo BTU',14,26); doc.text(`Fecha: ${fecha}`,14,32);

        let y=42, x=14;

        // Cliente
        const cn=($("clienteNombre").value||"").trim();
        const cd=($("clienteDireccion").value||"").trim();
        const ct=($("clienteTelefono").value||"").trim();
        if(cn||cd||ct){
          doc.setFont('helvetica','bold'); doc.text('Cliente',x,y); y+=6;
          doc.setFont('helvetica','normal');
          if(cn){ doc.text(`Nombre: ${cn}`,x,y); y+=6; }
          if(cd){ doc.text(`Dirección: ${cd}`,x,y); y+=6; }
          if(ct){ doc.text(`Teléfono: ${ct}`,x,y); y+=6; }
          y+=2;
        }

        // Entradas
        const area=$("area").value||"";
        const personas=$("personas").value||"0";
        const areaVentanas=$("areaVentanas").value||"0";
        const luminarias=$("luminarias").value||"0";
        const overshootTxt=$("toggleOvershoot").checked?"Sí":"No";

        doc.setFont('helvetica','bold'); doc.text('Entradas',x,y); y+=6;
        doc.setFont('helvetica','normal');
        [ `Área del local: ${area} m²`,
          `Personas: ${personas}`,
          `Área de ventanas: ${areaVentanas} m²`,
          `Luminarias: ${luminarias}`,
          `Permitir sobrecapacidad: ${overshootTxt}`].forEach(t=>{ doc.text(t,x,y); y+=6; });

        y+=2;
        // Resultado
        doc.setFont('helvetica','bold'); doc.text('Resultado',x,y); y+=6;
        doc.setFont('helvetica','normal');
        doc.text(`Total: ${fmt.format(Math.round(lastTotal))} BTU  (≈ ${tonsFromBTU(lastTotal).toFixed(2)} ton)`,x,y);
        y+=8;

        // Combos
        doc.setFont('helvetica','bold'); doc.text('Mejores combinaciones (top 5)',x,y); y+=6;
        doc.setFont('helvetica','normal');
        lastCombos.forEach((c,i)=>{
          const k=c.listaBTU.map(v=>`${Math.round(v/1000)} KBTU`).join(' + ');
          const diff=c.suma-lastTotal, sign=diff>=0?'+':'−', abs=fmt.format(Math.round(Math.abs(diff)));
          const l1=`${i+1}) ${k}`;
          const l2=`Suma: ${fmt.format(Math.round(c.suma))} BTU (≈ ${tonsFromBTU(c.suma).toFixed(2)} ton)  ·  Δ ${sign}${abs} BTU`;
          if(y>270){ doc.addPage(); y=18; }
          doc.text(l1,x,y); y+=6; doc.text(l2,x+4,y); y+=7;
        });

        return { doc, fileName };
      }

      async function descargarPDF(){
        if(!lastTotal) calcular();
        const { doc, fileName } = await buildPdf();
        try{
          await doc.save(fileName,{ returnPromise:true });
        }catch{
          const url=doc.output('bloburl'); window.open(url,'_blank');
        }
      }

      async function compartir(){
        if(!lastTotal) calcular();

        const { doc, fileName } = await buildPdf();
        const blob = doc.output('blob');
        const file = new File([blob], fileName, { type: 'application/pdf' });

        const resumen = `Cálculo BTU
Total: ${fmt.format(Math.round(lastTotal))} BTU (≈ ${tonsFromBTU(lastTotal).toFixed(2)} ton)
Top: ${lastCombos[0] ? lastCombos[0].listaBTU.map(v=>Math.round(v/1000)+' KBTU').join(' + ') : 'N/A'}`;

        try{
          if(navigator.canShare && navigator.canShare({ files:[file] })){
            await navigator.share({
              title: 'Reporte BTU - JC',
              text: resumen,
              files: [file]
            });
            return;
          }
        }catch{} // cae a fallback

        // Fallback: WhatsApp (texto) + abrir PDF en nueva pestaña para que lo guarden/adjunten
        const urlBlob = URL.createObjectURL(blob);
        window.open(urlBlob, '_blank'); // abrir PDF
        const wa = `https://wa.me/?text=${encodeURIComponent(resumen)}`;
        setTimeout(()=>window.open(wa,'_blank'), 400);

        // Fallback email (sin adjunto automático): abre compose con texto
        const mail = `mailto:?subject=${encodeURIComponent('Reporte BTU - JC')}&body=${encodeURIComponent(resumen)}`;
        setTimeout(()=>window.location.href=mail, 1000);
      }

      function resetAll(){
        ["clienteNombre","clienteDireccion","clienteTelefono","area","personas","areaVentanas","luminarias"].forEach(id=>$(id).value="");
        ["s5","tons"].forEach(id=>$(id).textContent="—");
        $("combos").innerHTML=""; $("nota").textContent="";
        lastTotal=0; lastCombos=[];
      }

      $("btnCalcular").addEventListener("click", calcular);
      $("btnPdf").addEventListener("click", descargarPDF);
      $("btnShare").addEventListener("click", compartir);
      $("btnReset").addEventListener("click", resetAll);

      // Prefill demo
      if(!$("area").value){
        $("clienteNombre").value="Juan Perez";
        $("clienteDireccion").value="San Francisco 730, Colonia Fuentes de San Hildefonso";
        $("clienteTelefono").value="9981554466";
        $("area").value="75"; $("personas").value="23"; $("areaVentanas").value="9.6"; $("luminarias").value="20";
      }
      calcular();
    </script>
  </body>
</html>
